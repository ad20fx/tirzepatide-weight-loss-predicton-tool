<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tirzepatide Weight Loss Prediction Calculator</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 { font-size: 2em; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 0.95em; }

    .content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 0;
    }

    .input-section {
      background: #f8f9fa;
      padding: 30px;
      border-right: 1px solid #e0e0e0;
    }

    .results-section { padding: 30px; }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 0.95em;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .hint { font-size: 0.85em; color: #666; margin-top: 5px; }

    .calculate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }

    .calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .calculate-btn:active { transform: translateY(0); }

    .chart-container {
      position: relative;
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chart-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .summary-card .value {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }

    .summary-card .label { font-size: 0.9em; opacity: 0.9; }

    .prediction-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    .prediction-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
    }

    .prediction-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .prediction-table tr:hover { background: #f8f9fa; }

    .prediction-table tr:last-child td {
      font-weight: 600;
      background: #f0f0f0;
    }

    .disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      font-size: 0.9em;
      line-height: 1.6;
    }

    .disclaimer strong { color: #856404; }

    .methodology {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      font-size: 0.9em;
    }

    .methodology h3 { color: #1976D2; margin-bottom: 10px; }

    /* Hide results until user calculates */
    #results-container { display: none; }

    .placeholder {
      background: #f5f5f5;
      border: 2px dashed #ccc;
      padding: 18px;
      border-radius: 12px;
      color: #555;
      line-height: 1.5;
    }

    @media (max-width: 968px) {
      .content { grid-template-columns: 1fr; }
      .input-section {
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üè• Tirzepatide Weight Loss Prediction Calculator</h1>
      <p>CART-Based Model | 72-Week Trajectory with IQR Confidence Intervals</p>
    </div>

    <div class="content">
      <div class="input-section">
        <h2 style="margin-bottom: 20px; color: #333;">Patient Information</h2>

        <div class="form-group">
          <label>Weight (kg) *</label>
          <input type="number" id="weight" placeholder="e.g., 95" step="0.1" />
          <div class="hint">Enter current body weight in kilograms</div>
        </div>

        <div class="form-group">
          <label>Height (cm) *</label>
          <input type="number" id="height" placeholder="e.g., 170" step="0.1" />
          <div class="hint">Enter height in centimeters</div>
        </div>

        <div class="form-group">
          <label>Age (years) *</label>
          <input type="number" id="age" placeholder="e.g., 45" />
          <div class="hint">Used for CART stratification (threshold: 51 years)</div>
        </div>

        <div class="form-group">
          <label>Biological Sex *</label>
          <select id="sex">
            <option value="" selected>Select...</option>
            <option value="Female">Female</option>
            <option value="Male">Male</option>
          </select>
          <div class="hint"></div>
        </div>

        <div class="form-group">
          <label>Tirzepatide Dose (mg) *</label>
          <select id="dose">
            <option value="" selected>Select dose...</option>
            <option value="5">5 mg (Low dose)</option>
            <option value="10">10 mg (Medium dose)</option>
            <option value="15">15 mg (High dose)</option>
          </select>
          <div class="hint"></div>
        </div>

        <div class="form-group">
          <label>Glycemic Status *</label>
          <select id="glycemic">
            <option value="" selected>Select...</option>
            <option value="None">No Diabetes</option>
            <option value="Prediabetes">Prediabetes</option>
          </select>
          <div class="hint">Prediabetes is currently modeled same as No Diabetes (can be adjusted if you want)</div>
        </div>

        <button class="calculate-btn" onclick="calculate()">üìä Calculate Prediction</button>

        <div class="methodology">
          <h3>üî¨ CART Methodology</h3>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li><strong>Decision Tree Logic:</strong>
              <ul style="margin-left: 20px; margin-top: 5px;">
                <li>1st Split: Dose level</li>
                <li>2nd Split: Age (‚â§51 vs &gt;51 years)</li>
                <li>3rd Split: Glycemic status (No Diabetes vs Prediabetes)</li>
              </ul>
            </li>
            <li><strong>IQR Bands:</strong> 25th‚Äì75th percentile (visualized as shaded band)</li>
          </ul>
        </div>
      </div>

      <div class="results-section">
        <h2 style="margin-bottom: 20px; color: #333;">Prediction Results</h2>

        <div id="results-placeholder" class="placeholder">
          Enter the patient details on the left, then click <strong>‚ÄúCalculate Prediction‚Äù</strong> to view:
          <ul style="margin-left: 18px; margin-top: 8px;">
            <li>72-week weight trajectory with IQR shaded band</li>
            <li>Total weight loss (%) trajectory with IQR shaded band</li>
            <li>Detailed table at key weeks</li>
          </ul>
        </div>

        <div id="results-container">
          <div class="summary-cards" id="summary-cards"></div>

          <div id="prediction-table-container">
            <h3 style="margin-bottom: 15px; color: #333;">üìã Detailed Predictions</h3>
            <table class="prediction-table">
              <thead>
                <tr>
                  <th>Week</th>
                  <th>Weight (kg)</th>
                  <th>BMI (kg/m¬≤)</th>
                  <th>Weight Loss (%)</th>
                  <th>IQR Range (kg)</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>

          <div class="chart-container">
            <div class="chart-title">üìâ Predicted Weight Trajectory (72 Weeks)</div>
            <canvas id="weightChart"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-title">üìä Total Weight Loss Percentage (72 Weeks)</div>
            <canvas id="twlChart"></canvas>
          </div>

          <div class="disclaimer">
            <strong>‚ö†Ô∏è Important Disclaimer:</strong><br />
            This tool is for informational purposes only and does not replace professional medical advice.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let weightChart = null;
    let twlChart = null;

    function showResultsUI() {
      document.getElementById('results-placeholder').style.display = 'none';
      document.getElementById('results-container').style.display = 'block';
    }

    function calculate() {
      const w = parseFloat(document.getElementById('weight').value);
      const h = parseFloat(document.getElementById('height').value);
      const a = parseInt(document.getElementById('age').value, 10);
      const s = document.getElementById('sex').value;
      const d = parseInt(document.getElementById('dose').value, 10);
      const gly = document.getElementById('glycemic').value; // None | Prediabetes

      // Validation
      if (isNaN(w) || isNaN(h) || isNaN(a) || !s || isNaN(d) || !gly) {
        alert('‚ö†Ô∏è Please fill in all required fields');
        return;
      }
      if (w < 40 || w > 300) { alert('‚ö†Ô∏è Please enter a valid weight between 40-300 kg'); return; }
      if (h < 120 || h > 250) { alert('‚ö†Ô∏è Please enter a valid height between 120-250 cm'); return; }
      if (a < 18 || a > 80) { alert('‚ö†Ô∏è Please enter a valid age between 18-80 years'); return; }

      showResultsUI();

      // BMI
      const hm = h / 100;
      const bmi = w / (hm * hm);

      // Baseline TWL at 72 weeks by dose (Prediabetes treated same as None by default)
      const baselineTWL = {
        5:  { base: 16.0 },
        10: { base: 20.8 },
        15: { base: 22.2 }
      };

      let twl_72 = baselineTWL[d].base;

      // Age branch
      if (a > 51) twl_72 *= 0.95;

      // Optional (if you want Prediabetes to reduce efficacy slightly):
      // if (gly === 'Prediabetes') twl_72 *= 0.97;

      // BMI adjustment
      const bmiReference = 37.5;
      const bmiAdjustment = 1 + (bmi - bmiReference) * 0.004;
      twl_72 *= bmiAdjustment;

      // Bounds
      twl_72 = Math.max(8, Math.min(twl_72, 28));

      // IQR boundaries by dose
      const iqrData = {
        5:  { q1: 8.0,  q3: 21.7 },
        10: { q1: 11.4, q3: 26.2 },
        15: { q1: 13.3, q3: 27.3 }
      };
      const q1_72 = iqrData[d].q1;
      const q3_72 = iqrData[d].q3;

      // Trajectory
      const timepoints = [0, 4, 8, 12, 24, 36, 52, 72];
      const predictions = [];

      timepoints.forEach((week) => {
        let timeFraction = 0;
        if (week > 0) timeFraction = 1 / (1 + Math.exp(-0.08 * (week - 25)));

        const twl = twl_72 * timeFraction;
        const twlLower = q1_72 * timeFraction;
        const twlUpper = q3_72 * timeFraction;

        const predictedWeight = w * (1 - twl / 100);

        // For weight, higher TWL => lower weight
        const weightLower = w * (1 - twlUpper / 100); // lower bound weight
        const weightUpper = w * (1 - twlLower / 100); // upper bound weight

        const predictedBMI = predictedWeight / (hm * hm);

        predictions.push({
          week,
          weight: predictedWeight,
          weightLower,
          weightUpper,
          bmi: predictedBMI,
          twl,
          twlLower,
          twlUpper
        });
      });

      displaySummaryCards(predictions, bmi);
      displayPredictionTable(predictions);
      createWeightChart(predictions);
      createTWLChart(predictions);
    }

    function displaySummaryCards(predictions, initialBMI) {
      const final = predictions[predictions.length - 1];
      const html = `
        <div class="summary-card">
          <div class="label">Initial BMI</div>
          <div class="value">${initialBMI.toFixed(1)}</div>
        </div>
        <div class="summary-card">
          <div class="label">Predicted BMI (72 weeks)</div>
          <div class="value">${final.bmi.toFixed(1)}</div>
        </div>
        <div class="summary-card">
          <div class="label">Total Weight Loss</div>
          <div class="value">${final.twl.toFixed(1)}%</div>
        </div>
        <div class="summary-card">
          <div class="label">Weight at 72 Weeks</div>
          <div class="value">${final.weight.toFixed(1)} kg</div>
        </div>
      `;
      document.getElementById('summary-cards').innerHTML = html;
    }

    function displayPredictionTable(predictions) {
      let html = '';
      predictions.forEach(p => {
        const iqrRange = `${p.weightLower.toFixed(1)} - ${p.weightUpper.toFixed(1)}`;
        html += `
          <tr>
            <td>${p.week}</td>
            <td>${p.weight.toFixed(1)}</td>
            <td>${p.bmi.toFixed(1)}</td>
            <td>${p.twl.toFixed(1)}%</td>
            <td>${iqrRange}</td>
          </tr>
        `;
      });
      document.getElementById('table-body').innerHTML = html;
    }

    // ‚úÖ IQR band shaded BETWEEN Lower & Upper (BLUE)
    function createWeightChart(predictions) {
      const ctx = document.getElementById('weightChart').getContext('2d');
      if (weightChart) weightChart.destroy();

      const blue = '#667eea';
      const blueFill = 'rgba(102, 126, 234, 0.12)';

      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: predictions.map(p => 'Week ' + p.week),
          datasets: [
            // Lower first
            {
              label: 'Lower IQR (25th %ile)',
              data: predictions.map(p => p.weightLower),
              borderColor: blue,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
              tension: 0.4
            },
            // Upper fills down to lower => shaded band is the IQR
            {
              label: 'Upper IQR (75th %ile)',
              data: predictions.map(p => p.weightUpper),
              borderColor: blue,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: '-1',
              backgroundColor: blueFill,
              tension: 0.4
            },
            // Predicted
            {
              label: 'Predicted Weight (kg)',
              data: predictions.map(p => p.weight),
              borderColor: blue,
              backgroundColor: 'rgba(102, 126, 234, 0.06)',
              borderWidth: 3,
              pointRadius: 5,
              fill: false,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12 }
          },
          scales: {
            y: { title: { display: true, text: 'Weight (kg)', font: { size: 14, weight: 'bold' } } },
            x: { title: { display: true, text: 'Time', font: { size: 14, weight: 'bold' } } }
          }
        }
      });
    }

    // ‚úÖ IQR band shaded BETWEEN Lower & Upper (PINK)
    function createTWLChart(predictions) {
      const ctx = document.getElementById('twlChart').getContext('2d');
      if (twlChart) twlChart.destroy();

      const pink = '#ff5aa5';
      const pinkFill = 'rgba(255, 90, 165, 0.12)';
      const twlLine = '#764ba2'; // predicted line stays purple

      twlChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: predictions.map(p => 'Week ' + p.week),
          datasets: [
            // Lower first
            {
              label: 'Lower IQR (25th %ile)',
              data: predictions.map(p => p.twlLower),
              borderColor: pink,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
              tension: 0.4
            },
            // Upper fills down to lower => shaded band is the IQR
            {
              label: 'Upper IQR (75th %ile)',
              data: predictions.map(p => p.twlUpper),
              borderColor: pink,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: '-1',
              backgroundColor: pinkFill,
              tension: 0.4
            },
            // Predicted
            {
              label: 'Predicted Weight Loss (%)',
              data: predictions.map(p => p.twl),
              borderColor: twlLine,
              backgroundColor: 'rgba(118, 75, 162, 0.06)',
              borderWidth: 3,
              pointRadius: 5,
              fill: false,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12 }
          },
          scales: {
            y: { title: { display: true, text: 'Total Weight Loss (%)', font: { size: 14, weight: 'bold' } } },
            x: { title: { display: true, text: 'Time', font: { size: 14, weight: 'bold' } } }
          }
        }
      });
    }
  </script>
</body>
</html>
